name: Deloitte Edinburgh Cyber Jobs Monitor

on:
  workflow_dispatch:
  schedule:
    # Runs at 08:15 UK time-ish (cron is UTC; UK is UTC in winter, BST in summer)
    - cron: "15 8 * * *"

permissions:
  contents: write
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Run monitor
        id: run_monitor
        run: |
          python monitor_deloitte_jobs.py

      - name: Create GitHub issue if new jobs found
        if: steps.run_monitor.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('.state/deloitte_jobs.json', 'utf8'));
            const title = `New Deloitte jobs detected (${new Date().toISOString().slice(0,10)})`;
            const bodyLines = [
              `Source: ${data.source_url}`,
              ``,
              `Latest check (UTC): ${data.last_checked_utc}`,
              ``,
              `Jobs currently found: ${data.jobs.length}`,
              ``,
              `If you want to see exactly what's new, compare this issue time with the previous issue.`,
            ];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: bodyLines.join('\n')
            });

      - name: Commit updated state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .state/deloitte_jobs.json
          git diff --cached --quiet && echo "No state changes to commit" || git commit -m "Update Deloitte jobs state"
          git push
