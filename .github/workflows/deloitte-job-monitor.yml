name: Deloitte Edinburgh/Glasgow Jobs Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "15 8 * * *"   # 08:15 UTC daily

permissions:
  contents: write
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Run monitor
        id: run_monitor
        run: |
          python monitor_deloitte_jobs.py

      - name: Create GitHub issue if new jobs found
        if: steps.run_monitor.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('.state/last_run_report.json', 'utf8'));
            const lines = [];
            lines.push(`Base URL: ${report.base_url}`);
            lines.push(`Run (UTC): ${report.run_utc}`);
            lines.push('');
            for (const r of report.results) {
              if ((r.new_jobs_found || 0) > 0) {
                lines.push(`## ${r.label}`);
                lines.push(`Jobs found: ${r.jobs_found}`);
                lines.push(`New jobs: ${r.new_jobs_found}`);
                lines.push('');
                for (const j of r.new_jobs) {
                  lines.push(`- ${j.title} â€” ${j.url}`);
                }
                lines.push('');
              }
            }
            const title = `New Deloitte job(s) detected (${new Date().toISOString().slice(0,10)})`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: lines.join('\n')
            });

      - name: Commit updated state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .state/*.json
          git diff --cached --quiet && echo "No state changes to commit" || git commit -m "Update Deloitte jobs state"
          git push
